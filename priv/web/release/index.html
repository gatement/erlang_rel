<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Release Console</title>
<script src="/static/jquery.min.js"></script>
<script type="text/javascript">

var websocket;
$(document).ready(init);

function init() {
    if(!("WebSocket" in window)){  
        $("#status").html('<p><span style="color: red;">websockets are not supported</span></p>');
        $("#content").hide();  
    } else {
        $("#status").html('<p><span style="color: green;">server is not connected</span></p>');
        connect();
    };
};

// ===================================================================
// Websocket Functions
// ===================================================================
function connect() {
    var wsHost = "wss://" + window.location.host + "/ws/release";
    websocket = new WebSocket(wsHost);
    output('<b>Connecting to: ' +  wsHost + '</b>'); 
    websocket.onopen = function(evt) { onOpen(evt) }; 
    websocket.onclose = function(evt) { onClose(evt) }; 
    websocket.onmessage = function(evt) { onMessage(evt) }; 
    websocket.onerror = function(evt) { onError(evt) }; 
};  

function disconnect() {
    websocket.close();
}; 

function sendTxt(txt) {
    if(websocket.readyState == websocket.OPEN) {
        websocket.send(txt);
        output('SEND: ' + txt); 
    } else {
        output('Websocket is not connected'); 
    };
};

// ===================================================================
// WebSocket Callback Functions
// ===================================================================
function onOpen(evt) { 
    $('#status').html('<p><span style="color: green;">server is connected</span></p>');
    output('<span style="color: green;">CONNECTED</span>'); 
};  

function onClose(evt) { 
    $('#status').html('<p><span style="color: green;">server is not connected</span></p>');
    output('<span style="color: red;">DISCONNECTED</span>');
    window.setTimeout(connect, 5000); // reconnect
};  

function onMessage(evt) { 
    var vals = evt.data.split("|");
    var cmd = vals[0];
    var val = vals[1];
    if(cmd == "msg")
    {
        output('<span style="color: red;">RESPONSE:[' + getTimeStr() + ']' + val + '</span>');
    }
};  

function onError(evt) {
    output('<span style="color: red;">ERROR:[' + getTimeStr() + ']' + evt.data+ '</span>');
};

// ===================================================================
// Handler Functions
// ===================================================================
function runTest() {
    sendTxt("run_test");
};

// ===================================================================
// Helper Functions
// ===================================================================
function output(txt) { 
    $('#output').prepend('<p>' + txt + '</p>');
};

function clearOutput() { 
    $('#output').html("");
};

function getTimeStr() {
    var now = new Date();
    var hours = now.getHours();
    var minutes = now.getMinutes();
    var seconds = now.getSeconds();
    var timeValue = "";
    timeValue += ((hours < 10) ? "0" : "") + hours;
    timeValue += ((minutes < 10) ? ":0" : ":") + minutes;
    timeValue += ((seconds < 10) ? ":0" : ":") + seconds;
    return timeValue;
};

</script>
</head>

<body>
    <div id="header">
        <h3>Release Console</h3>
        <div id="status"></div>
    </div>
    <div id="content">
        <fieldset>
            <legend>operations</legend>
            <div id="operations">
                <button id="clear" onclick="clearOutput()" >clear output</button>
            </div>
        </fieldset>
        <fieldset>
            <legend>output</legend>
            <div id="output"></div>
        </fieldset>
    </div>
</body>
</html> 
